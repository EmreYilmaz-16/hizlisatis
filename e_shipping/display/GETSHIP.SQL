CREATE PROCEDURE workcube_metosan_1.GET_SHIPPING @PROPERTY_VALUE nvarchar(max),
@PRODUCT_ID NVARCHAR(MAX),
@START_DATE DATETIME,
@END_DATE DATETIME,
@LISTING_TYPE INT,
@BRANCH_ID INT,
AS BEGIN
DECLARE @CARI_KONTROL INT
SELECT @CARI_KONTROL = count(*)
FROM (
        SELECT ESR.SHIP_RESULT_ID,
            O.COMPANY_ID,
            O.CONSUMER_ID,
            ESR.COMPANY_ID AS COMP_ID,
            ESR.CONSUMER_ID AS CONS_ID
        FROM workcube_metosan_1.PRTOTM_SHIP_RESULT AS ESR
            INNER JOIN workcube_metosan_1.PRTOTM_SHIP_RESULT_ROW AS ESRR ON ESR.SHIP_RESULT_ID = ESRR.SHIP_RESULT_ID
            INNER JOIN workcube_metosan_1.ORDER_ROW AS ORR ON ESRR.ORDER_ROW_ID = ORR.ORDER_ROW_ID
            INNER JOIN workcube_metosan_1.ORDERS AS O ON ORR.ORDER_ID = O.ORDER_ID
        WHERE 1 = 1
        GROUP BY ESR.SHIP_RESULT_ID,
            O.COMPANY_ID,
            O.CONSUMER_ID,
            ESR.COMPANY_ID,
            ESR.CONSUMER_ID
    ) AS TBL
WHERE COMPANY_ID <> COMP_ID
    OR CONSUMER_ID <> CONS_ID PRINT @CARI_KONTROL
DECLARE @HATA_COUNT INT
SELECT @HATA_COUNT = COUNT(*)
FROM (
        SELECT ESR.SHIP_RESULT_ID,
            O.CITY_ID,
            O.COUNTY_ID
        FROM workcube_metosan_1.PRTOTM_SHIP_RESULT AS ESR
            INNER JOIN workcube_metosan_1.PRTOTM_SHIP_RESULT_ROW AS ESRR ON ESR.SHIP_RESULT_ID = ESRR.SHIP_RESULT_ID
            INNER JOIN workcube_metosan_1.ORDER_ROW AS ORR ON ESRR.ORDER_ROW_ID = ORR.ORDER_ROW_ID
            INNER JOIN workcube_metosan_1.ORDERS AS O ON ORR.ORDER_ID = O.ORDER_ID
        WHERE 1 = 1
            AND ESR.OUT_DATE >= IIF (@START_DATE IS NULL, OUT_DATE, @START_DATE)
            AND ESR.OUT_DATE <= IIF (@END_DATE IS NULL, OUT_DATE, @END_DATE)
        GROUP BY ESR.SHIP_RESULT_ID,
            O.CITY_ID,
            O.COUNTY_ID
    ) AS TBL
GROUP BY SHIP_RESULT_ID
DECLARE @TIP INT
HAVING COUNT(*) > 1 IF(ISNULL(@CC, 0) <> 0) BEGIN
SET @TIP = 1
SELECT O.ORDER_NUMBER,
    O.ORDER_ID,
    ESR.DELIVER_PAPER_NO,
    ESR.SHIP_RESULT_ID,
    SC.CITY_NAME,
    SCO.COUNTY_NAME,
    SM.SHIP_METHOD,
    O.COMPANY_ID,
    O.CONSUMER_ID,
    O.EMPLOYEE_ID,
    ESR.OUT_DATE
FROM PRTOTM_SHIP_RESULT AS ESR
    INNER JOIN PRTOTM_SHIP_RESULT_ROW AS ESRR ON ESR.SHIP_RESULT_ID = ESRR.SHIP_RESULT_ID
    INNER JOIN ORDER_ROW AS ORR ON ESRR.ORDER_ROW_ID = ORR.ORDER_ROW_ID
    INNER JOIN ORDERS AS O ON ORR.ORDER_ID = O.ORDER_ID
    LEFT OUTER JOIN workcube_metosan.SETUP_CITY AS SC ON O.CITY_ID = SC.CITY_ID
    LEFT OUTER JOIN workcube_metosan.SETUP_COUNTY AS SCO ON O.COUNTY_ID = SCO.COUNTY_ID
    LEFT OUTER JOIN workcube_metosan.SHIP_METHOD AS SM ON O.SHIP_METHOD = SM.SHIP_METHOD_ID
WHERE ESR.SHIP_RESULT_ID IN (
        SELECT SHIP_RESULT_ID
        FROM (
                SELECT ESR.SHIP_RESULT_ID,
                    O.CITY_ID,
                    O.COUNTY_ID
                FROM workcube_metosan_1.PRTOTM_SHIP_RESULT AS ESR
                    INNER JOIN workcube_metosan_1.PRTOTM_SHIP_RESULT_ROW AS ESRR ON ESR.SHIP_RESULT_ID = ESRR.SHIP_RESULT_ID
                    INNER JOIN workcube_metosan_1.ORDER_ROW AS ORR ON ESRR.ORDER_ROW_ID = ORR.ORDER_ROW_ID
                    INNER JOIN workcube_metosan_1.ORDERS AS O ON ORR.ORDER_ID = O.ORDER_ID
                WHERE 1 = 1
                    AND ESR.OUT_DATE >= IIF (@START_DATE IS NULL, OUT_DATE, @START_DATE)
                    AND ESR.OUT_DATE <= IIF (@END_DATE IS NULL, OUT_DATE, @END_DATE)
                GROUP BY ESR.SHIP_RESULT_ID,
                    O.CITY_ID,
                    O.COUNTY_ID
            ) AS TBL
        GROUP BY SHIP_RESULT_ID
        HAVING COUNT(*) > 1
    )
GROUP BY O.ORDER_NUMBER,
    O.ORDER_ID,
    ESR.DELIVER_PAPER_NO,
    ESR.SHIP_RESULT_ID,
    SC.CITY_NAME,
    SCO.COUNTY_NAME,
    SM.SHIP_METHOD,
    O.COMPANY_ID,
    O.CONSUMER_ID,
    O.EMPLOYEE_ID,
    ESR.OUT_DATE
ORDER BY ESR.DELIVER_PAPER_NO
END
ELSE IF(@CARI_KONTROL > 0) BEGIN
SET @TIP = 2
SELECT O.ORDER_NUMBER,
    O.ORDER_ID,
    ESR.DELIVER_PAPER_NO,
    ESR.SHIP_RESULT_ID,
    ESR.COMPANY_ID COMP_ID,
    ESR.CONSUMER_ID CONS_ID,
    SC.CITY_NAME,
    SCO.COUNTY_NAME,
    SM.SHIP_METHOD,
    O.COMPANY_ID,
    O.CONSUMER_ID,
    O.EMPLOYEE_ID,
    ESR.OUT_DATE
FROM PRTOTM_SHIP_RESULT AS ESR
    INNER JOIN PRTOTM_SHIP_RESULT_ROW AS ESRR ON ESR.SHIP_RESULT_ID = ESRR.SHIP_RESULT_ID
    INNER JOIN ORDER_ROW AS ORR ON ESRR.ORDER_ROW_ID = ORR.ORDER_ROW_ID
    INNER JOIN ORDERS AS O ON ORR.ORDER_ID = O.ORDER_ID
    LEFT OUTER JOIN workcube_metosan.SETUP_CITY AS SC ON O.CITY_ID = SC.CITY_ID
    LEFT OUTER JOIN workcube_metosan.SETUP_COUNTY AS SCO ON O.COUNTY_ID = SCO.COUNTY_ID
    LEFT OUTER JOIN workcube_metosan.SHIP_METHOD AS SM ON O.SHIP_METHOD = SM.SHIP_METHOD_ID
WHERE ESR.SHIP_RESULT_ID IN (
        SELECT SHIP_RESULT_ID
        FROM (
                SELECT ESR.SHIP_RESULT_ID,
                    O.COMPANY_ID,
                    O.CONSUMER_ID,
                    ESR.COMPANY_ID AS COMP_ID,
                    ESR.CONSUMER_ID AS CONS_ID
                FROM PRTOTM_SHIP_RESULT AS ESR
                    INNER JOIN PRTOTM_SHIP_RESULT_ROW AS ESRR ON ESR.SHIP_RESULT_ID = ESRR.SHIP_RESULT_ID
                    INNER JOIN ORDER_ROW AS ORR ON ESRR.ORDER_ROW_ID = ORR.ORDER_ROW_ID
                    INNER JOIN ORDERS AS O ON ORR.ORDER_ID = O.ORDER_ID
                WHERE 1 = 1
                GROUP BY ESR.SHIP_RESULT_ID,
                    O.COMPANY_ID,
                    O.CONSUMER_ID,
                    ESR.COMPANY_ID,
                    ESR.CONSUMER_ID
            ) AS TBL
        WHERE COMPANY_ID <> COMP_ID
            OR CONSUMER_ID <> CONS_ID
    )
GROUP BY O.ORDER_NUMBER,
    O.ORDER_ID,
    O.REF_NO,
    ESR.DELIVER_PAPER_NO,
    ESR.SHIP_RESULT_ID,
    ESR.COMPANY_ID,
    ESR.CONSUMER_ID,
    SC.CITY_NAME,
    SCO.COUNTY_NAME,
    SM.SHIP_METHOD,
    O.COMPANY_ID,
    O.CONSUMER_ID,
    O.EMPLOYEE_ID,
    ESR.OUT_DATE
ORDER BY ESR.SHIP_RESULT_ID
END
ELSE BEGIN IF(@LISTING_TYPE <> 3) BEGIN
END
END
END